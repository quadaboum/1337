<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Admin ‚Äì Topaz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
    // Easter egg : citation mystique apr√®s 10s sur Dashboard
    window.addEventListener('DOMContentLoaded', function() {
        let dash = document.getElementById('admin-dashboard-link');
        if (dash) {
            let timer = null;
            dash.addEventListener('mouseenter', function() {
                timer = setTimeout(function() {
                    let c = document.getElementById('dashboard-quote');
                    if(c) c.style.display = 'block';
                }, 10000);
            });
            dash.addEventListener('mouseleave', function() {
                clearTimeout(timer);
                let c = document.getElementById('dashboard-quote');
                if(c) c.style.display = 'none';
            });
        }
    });
    // Konami code easter egg
    document.addEventListener('DOMContentLoaded', function() {
        var k = [], code = "38384040373937396665";
        document.body.addEventListener("keydown", function(e) {
            k.push(e.keyCode);
            if (k.join('').indexOf(code) > -1) {
                alert("Topaz t‚Äôobserve üëÅÔ∏è");
                document.body.classList.toggle('glitch');
                k = [];
            }
            if (k.length > 20) k.shift();
        });
    });
    </script>
</head>
<body class="dark">
    <div class="sidebar">
        <h2>{{ user.username }}</h2>
        <nav>
            <a href="{{ url_for('menu') }}">Menu principal</a>
            <a id="admin-dashboard-link" href="{{ url_for('dashboard') }}" class="active">Dashboard Admin</a>
            <span id="dashboard-quote" style="display:none; color:#99f; font-style:italic;">
                ‚ÄúLe secret de l‚Äô√©clipse est dans ton ombre‚Ä¶‚Äù
            </span>
            <a href="{{ url_for('logout') }}">D√©connexion</a>
        </nav>
    </div>
    <main>
        <h1 ondblclick="alert('Le vrai gourou, c\'est toi, iGz.')">Dashboard Administrateur</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash">
            {% for category, message in messages %}
                <div class="alert {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <h2>Stats g√©n√©rales</h2>
        <ul>
            <li>Nombre d'utilisateurs : {{ stats.user_count }}</li>
            <li>Niveau moyen : {{ stats.level_avg }}</li>
            <li>Prestige total : {{ stats.prestige_total }}</li>
        </ul>

        <h2>Utilisateurs</h2>
        <table>
            <tr><th>Pseudo</th><th>Niveau</th><th>Prestige</th><th>IP</th><th>User-Agent</th><th>Cr√©√© le</th><th>Actions</th></tr>
            {% for u in users %}
            <tr>
                <td>{{ u.username }}</td>
                <td>{{ u.level }}</td>
                <td>{{ u.prestige }}</td>
                <td>{{ u.last_ip or "-" }}</td>
                <td class="ua">{{ u.user_agent or "-" }}</td>
                <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') if u.created_at else "-" }}</td>
                <td>
                    {% if u.username != "Topaz" %}
                    <form action="{{ url_for('delete_user', user_id=u.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="danger">Supprimer</button>
                    </form>
                    {% else %}
                    <span title="Intouchable, demi-dieu">üõ°Ô∏è</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

        <h2>Codes d'invitation</h2>
        <form action="{{ url_for('generate_invite') }}" method="post" style="margin-bottom:1em;">
            <button type="submit">G√©n√©rer un code d'invitation</button>
        </form>
        <ul>
            {% for invite in invites %}
            <li>{{ invite.code }}</li>
            {% endfor %}
        </ul>

        <div style="margin-top:2em; font-size:1.1em;">
            <b>Version :</b> {{ version }}
            {% if version == "3.3" %}
                <span style="color:#4df;">(Derni√®re grosse release)</span>
            {% endif %}
            <br>
            <a href="{{ url_for('static', filename='CHANGELOG.md') }}" target="_blank">
                Voir le changelog complet
            </a>
        </div>

    </main>
</body>
</html>
